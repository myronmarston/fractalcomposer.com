<%
  div_ids = ['piece_settings', 'voices', 'sections']
  div_names = ['Piece Settings', 'Voices', 'Sections']
  additional_tab_js = ['',
    remote_function(:url => {:action => 'voices_tab_selected_xhr'},
                    :with => "Form.serialize($('compose_form'))") + '; ', 
    remote_function(:url => {:action => 'sections_tab_selected_xhr'},
                    :with => "Form.serialize($('compose_form'))") + '; ']
-%>

<%= render :partial => 'layouts/tabpanel_js', :locals => {:div_ids => div_ids} -%>
<% form_remote_tag  :url => {:action => 'generate_piece_xhr'},
                    :html => {:id => 'compose_form'},
                    :update => 'piece_midi_player_wrapper',
                    :before => "$('piece_spinner').show()",
                    :complete => "$('piece_spinner').hide()" do %>
    <% div_ids.each do |div_id| -%>
        <div id="<%= div_id %>" style="display:<%= if div_id == 'voices' then 'block' else 'none' end %>;">
          <%= render :partial => 'layouts/tabpanel_list',
                     :locals => {
                        :div_ids => div_ids,                      
                        :div_names => div_names,
                        :div_current => div_id,
                        :additional_tab_js => additional_tab_js } %>
          <div class="tab_panel_body">
            <%= render :partial => div_id %>
          </div>
        </div>
    <% end -%>    
    
    <div>
      <%= submit_tag 'Generate Piece', :id => 'generate_piece_button', :class => 'button' %>           
      <%= image_tag 'indicator.gif', :style => 'display: none;', :id => 'piece_spinner' %>    
      <span id="piece_midi_player_wrapper">  
          <%= render :partial => 'midi_player', :locals => {:midi_filename => @piece_filename, :div_id => 'piece_midi_player'} %>        
      </span>
    </div>
<% end %>