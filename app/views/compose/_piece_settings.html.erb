  <div class="piece_settings_wrap">    
    <%= render :partial => 'scale_selection', :locals => {:scale => @fractal_piece.getScale, :input_prefix => '', :id_to_serialize => nil, :generate_update_germ_js => true} %>    
        
    <% field_wrap('Time Signature', 'time_signature', nil, '<br />') do %>
      <%= text_field_tag :time_signature, @fractal_piece.getTimeSignature, :size => 4, :class => 'textbox' %>
      <%= get_live_validation_js('time_signature', true, 'piece_settings', nil, 'Time Signature', nil, 
          "{type: Validate.Presence, args: {} }, {type: Validate.Format, args: { pattern: /#{com.myronmarston.music.settings.TimeSignature::REGEX_PATTERN_STRING}/, failureMessage: 'Must be a positive fraction with a power of 2 in the denominator.' } }") %>
      <% remote_time_sig_js = remote_function(
          :url => { :action => :set_time_signature_xhr },          
          :with  => "'time_signature=' + encodeURIComponent(value)" + observe_field_with_js_for_field_that_effects_germ,
          :before  => observe_field_before_js_for_field_that_effects_germ,
          :complete  => observe_field_complete_js_for_field_that_effects_germ,
          :condition => "#{get_live_validation_var_name('time_signature')}.validate()") %>
      <%= observe_field :time_signature, :function => remote_time_sig_js %>    
    <% end %>
    
    <% field_wrap('Tempo', 'tempo', nil, '<br />') do %>
      <%= text_field_tag :tempo, @fractal_piece.getTempo, :size => 4, :class => 'textbox' %>
      <%= get_live_validation_js('tempo', true, 'piece_settings', nil, 'Tempo', nil,
          "{type: Validate.Presence, args: {}}, {type: Validate.Numericality, args: { onlyInteger: true, minimum: #{com.myronmarston.music.Tempo::MIN_TEMPO_BPM}, maximum: #{com.myronmarston.music.Tempo::MAX_TEMPO_BPM}, notANumberMessage: 'Must be an integer!' }}") %>    
    <% end %>
    
    <% field_wrap('Germ', 'germ') do %>      
      <div><!--This div is present to prevent a bug when expanding the germ info, where the text area loses its content-->
        <%= text_area_tag :germ_string, h(session[:germ_string]), :size => '25x3', :class => 'textbox' %>
        <%= observe_field :germ_string, 
            :url => { :action => :set_germ_xhr },         
            :with => "'germ_string='+encodeURIComponent(value)",
            :before => "$('germ_spinner').show(); $('germ_midi_player_wrapper').hide()",
            :complete => "$('germ_spinner').hide(); $('germ_midi_player_wrapper').show()" %>    
      </div>
    <% end %>

    <%= render :partial => 'spinner', :locals => {:div_id => 'germ_spinner', :display => 'none', :bottom_px => -4} %>    
    <div id="germ_midi_player_wrapper"<%= get_style_for_germ_midi_player_wrapper %>>  
        <%= render :partial => 'germ_midi_and_image', :locals => {:play_immediately => false} %>
    </div>    
    
    <br />
    <% field_wrap('Generate Layered Intro', 'generate_layered_intro', nil, '<br />') do %>
        <%= check_box_tag :generate_layered_intro, 1, @fractal_piece.getGenerateLayeredIntro %>
    <% end %>
    
    <% field_wrap('Generate Layered Outro', 'generate_layered_outro') do %>
        <%= check_box_tag :generate_layered_outro, 1, @fractal_piece.getGenerateLayeredOutro %>
    <% end %>
  </div>